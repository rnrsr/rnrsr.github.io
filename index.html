<!DOCTYPE html>
<html>
  <head>
    <title>rnrsr</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    
    <style>
      span.result.bad { color: red; font-weight: bold; }
      span.result.bad a:link, span.result.bad a:visited { color: red; text-decoration: underline; }
      .checklist { background-color: yellow; max-height: 6em; overflow-y: scroll; }
    </style>

  </head>
  <body>
    <h1>hi.</h1>
    <p>Welcome, stranger.</p>
    <p>IP:v<span id="ip"></span></p>
    <!--<p>Approximate location: <span id="location"></span></p>
    <p>ISP: <span id="isp"></span></p>-->
    <p>
      Are you running insecure development servers on localhost?
      <br /><br />
      Let me check some common ports for you:
    </p>
    
    <p id="local_checklist" class="checklist">
    </p>
    <p id="network_checklist" class="checklist">
    </p>
    
    <p id="admission">
      Its an easy mistake to make:<br />
      <br />
      <code>from flask import Flask</code><br />
      <code>from flask_cors import CORS</code><br />
      <br />
      <code>app = Flask(__name__)</code><br />
      <code>cors = CORS(app, resources={r"*": {"origins": "*"}})</code><br />
      <br />
      <code>@app.route('/')</code><br />
      <code>def index():</code><br />
      <code>&nbsp;&nbsp;return 'Hello world'</code><br />
      <br />
      <code>if __name__ == '__main__':</code><br />
      <code>&nbsp;&nbsp;app.run(debug=True, host='0.0.0.0')</code><br />
    </p>
    
    <script>
      const localChecklist = document.getElementById("local_checklist");
      const networkChecklist = document.getElementById("network_checklist");
      const portsToTry = [
        80, 81, 88,
        3000, 3001, 3030, 3031, 3333,
        4000, 4001, 4040, 4041, 4444,
        5000, 5001, 5050, 5051, 5555,
        6000, 6001, 6060, 6061, 6666,
        7000, 7001, 7070, 7071, 7777,
        8000, 8001, 8080, 8081, 8888,
        9000, 9001, 9090, 9091, 9999,
      ];

      function logLine(checklist, text, className) {
        const span = document.createElement("span");
        span.innerHTML = text + " ";
        span.setAttribute("class", "result" + " " + className);
        checklist.appendChild(span);
        checklist.scrollTop = checklist.scrollHeight;
      }

      function timeoutPromise(ms, promise) {
        return new Promise((resolve, reject) => {
          const timeoutId = setTimeout(() => {
            reject(new Error("TIMEOUT"));
          }, ms);
          promise.then(
            res => {
              clearTimeout(timeoutId);
              resolve(res);
            },
            err => {
              clearTimeout(timeoutId);
              reject(err);
            }
          );
        })
      }

      function getLocalNetworkPrefix(cb) {
        var RTCPeerConnection = window.RTCPeerConnection || webkitRTCPeerConnection || mozRTCPeerConnection;
        var peerConn = new RTCPeerConnection({'iceServers': [{'urls': ['stun:stun.l.google.com:19302']}]});
        var dataChannel = peerConn.createDataChannel('test');  // Needs something added for some reason
        peerConn.createOffer({}).then((desc) => peerConn.setLocalDescription(desc));
        peerConn.onicecandidate = (e) => {
          if (e.candidate == null) {
            cb(/(192\.168\.[0-9]+\.)[0-9]+/.exec(peerConn.localDescription.sdp)[1]);
          }
        };
      }

      function scanHost(hostname, checklist, cb) {
        logLine(checklist, `Scanning ${hostname} ...`, "");
        function loop(portIndex) {
          if (portIndex >= portsToTry.length) {
            logLine(checklist, `${hostname} complete.`, "");
            cb();
          } else {
            const port = portsToTry[portIndex];
            const url = `http://${hostname}:${port}`;
            timeoutPromise(2000, fetch(url)).then(
              response => {
                logLine(checklist, `<a href="http://${hostname}:${port}" target="_blank">${hostname}:${port}</a> is available!`, "bad");
                loop(portIndex+1);
              },
              e => {
                if (e.message == "TIMEOUT") {
                  // Assume this host is unreachable. Don't waste time; go to the next host.
                  logLine(checklist, `unreachable.`, "");
                  cb();
                } else {
                  loop(portIndex+1);
                }
              }
            );
          }
        }
        loop(0);
      }

      function scanNetwork(localNetworkPrefix) {
        logLine(networkChecklist, "Scanning network ...", "");
        function loop(lowByte) {
          if (lowByte > 255) {
            logLine(networkChecklist, `Network scan complete.`, "");
          } else {
            const hostname = localNetworkPrefix + lowByte;
            scanHost(hostname, networkChecklist, () => {
              loop(lowByte+1);
            });
          }
        }
        loop(1);
      }
      
      function getIP() {
        timeoutPromise(2000, fetch('http://ip-api.com/json')).then(
          response => {
            document.getElementById("ip").innerHTML=response
          },
          e => {
          }
        );
      }

      getIP();
      scanHost("localhost", localChecklist, () => {
        getLocalNetworkPrefix(prefix => {
          scanNetwork(prefix);
        })
      });
    </script>

  </body>
</html>
